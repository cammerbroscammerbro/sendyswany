<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CipherQ Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0a0a0a;
      color: #fff;
      font-family: "Poppins", sans-serif;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      border-right: 1px solid #222;
    }

    .sidebar h2 {
      margin-bottom: 40px;
      font-size: 22px;
      letter-spacing: 1px;
    }

    .sidebar button {
      width: 80%;
      margin: 10px 0;
      padding: 12px 0;
      background: #1b1b1b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .sidebar button.active {
      background: #007bff;
    }

    .sidebar button:hover {
      background: #333;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 25px;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 25px;
    }

    .get-key-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .get-key-btn:hover {
      background: #0056b3;
    }

    /* Content area */
    .content-area {
      flex: 1;
      background: #121212;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
    }

    .content-area h3 {
      font-size: 20px;
      margin-bottom: 15px;
    }

    .api-key-box {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>CipherQ</h2>
    <button id="apiKeyBtn" class="active">API Key</button>
    <button id="docsBtn">Docs</button>
  </div>

  <!-- Main Section -->
  <div class="main-content">
    <div class="top-bar">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="get-key-btn">Get API Key</button>
        <div id="userInfo" style="color:#cbd5e1;font-size:14px;">
          <!-- UID/email will be injected here -->
        </div>
        <button id="logoutBtn" style="margin-left:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe8ff;padding:8px 12px;border-radius:8px;cursor:pointer">Logout</button>
      </div>
    </div>

    <div id="contentArea" class="content-area">
      <h3>Your API Key</h3>
      <p>Welcome to CipherQ Quantum Encryption API. Here’s your generated API Key:</p>
      <div class="api-key-box" id="apiKeyBox">
        21ae5bd31aadb0bd76a5390139fd1267e414da5ee39250a5d294c2c0e65ecba4
      </div>
      <p style="margin-top: 15px;">Use this key with your HTTP headers as:  
        <code style="background:#222;padding:5px 10px;border-radius:5px;">X-API-KEY: your_api_key_here</code>
      </p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const apiBtn = document.getElementById('apiKeyBtn');
    const docsBtn = document.getElementById('docsBtn');
    const content = document.getElementById('contentArea');

    apiBtn.addEventListener('click', () => {
      apiBtn.classList.add('active');
      docsBtn.classList.remove('active');
      // content controlled by auth listener
    });

    docsBtn.addEventListener('click', () => {
      // open docs in same tab (full page)
      window.location.href = "doc.html";
    });

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqzy8ivw9QZG6RXNQmoTKAWY_1uunTTrw",
      authDomain: "pcq-api.firebaseapp.com",
      databaseURL: "https://pcq-api-default-rtdb.firebaseio.com",
      projectId: "pcq-api",
      storageBucket: "pcq-api.firebasestorage.app",
      messagingSenderId: "759573347127",
      appId: "1:759573347127:web:2e89d43e000b4df57838b2",
      measurementId: "G-RTT59R8JBW"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Utility: escape HTML for safe rendering
    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]);
    }

    // Render user data (APIs and meta) with delete/revoke controls
    function renderUserData(data){
      const apis = data && data.apis ? data.apis : {};
      let html = `<h3>Your API Keys</h3>`;
      if(Object.keys(apis).length){
        html += '<div id="userApis">';
        Object.entries(apis).forEach(([k,v]) => {
          const keyText = (v && v.key) ? v.key : (typeof v === 'string' ? v : '');
          const created = v && v.createdAt ? new Date(v.createdAt).toLocaleString() : '';
          html += `<div class="api-key-box" data-id="${escapeHtml(k)}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                      <div><strong style="font-family:monospace">${escapeHtml(keyText)}</strong>
                        <div style="color:#9aa6b8;font-size:12px;margin-top:6px">id: ${escapeHtml(k)}</div>
                        <div style="color:#9aa6b8;font-size:12px">${escapeHtml(created)}</div>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:8px">
                        <button class="revokeBtn" data-id="${escapeHtml(k)}" style="background:#f97316;border-radius:8px;padding:8px;border:none;color:white;cursor:pointer">Revoke</button>
                        <button class="deleteBtn" data-id="${escapeHtml(k)}" style="background:#ef4444;border-radius:8px;padding:8px;border:none;color:white;cursor:pointer">Delete</button>
                      </div>
                    </div>
                  </div>`;
        });
        html += '</div>';
      } else {
        html += `<p>No API keys yet for this account.</p>`;
        html += `<button id="createKeyBtn" class="get-key-btn">Create API Key</button>`;
      }

      // Additional metadata
      if(data && data.email){
        html += `<p style="margin-top:12px;color:#9aa6b8;font-size:13px">Account: ${escapeHtml(data.email)}</p>`;
      }

      content.innerHTML = html;

      const createBtn = document.getElementById('createKeyBtn');
      if(createBtn) createBtn.addEventListener('click', createApiKeyForCurrentUser);

      // attach delete/revoke
      document.querySelectorAll('.deleteBtn').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if(!confirm('Delete this API key permanently?')) return;
        try{
          const uid = auth.currentUser && auth.currentUser.uid;
          if(!uid) throw new Error('Not authenticated');
          await remove(ref(db, `users/${uid}/apis/${id}`));
        }catch(err){console.error(err);alert('Failed to delete key')}
      }));

      document.querySelectorAll('.revokeBtn').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if(!confirm('Revoke this API key (will delete it)?')) return;
        try{
          const uid = auth.currentUser && auth.currentUser.uid;
          if(!uid) throw new Error('Not authenticated');
          // For now revoke == delete. In future we can add a 'revoked:true' flag.
          await remove(ref(db, `users/${uid}/apis/${id}`));
        }catch(err){console.error(err);alert('Failed to revoke key')}
      }));
    }

    // Generate a secure-ish API key (client-side). For production, generate on server.
    function generateApiKey(){
      const arr = new Uint8Array(24);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function createApiKeyForCurrentUser(){
      const user = auth.currentUser;
      if(!user){ alert('No user signed in.'); return; }
      const uid = user.uid;
      const newKey = generateApiKey();
      const payload = { key: newKey, createdAt: Date.now() };
      try{
        await push(ref(db, `users/${uid}/apis`), payload);
      }catch(e){
        console.error('Failed to create API key', e);
        alert('Could not create API key. Check console for details.');
      }
    }

    // Fetch user record and attach realtime listener (same as before)
    function fetchAndListenUser(uid){
      try{
        const userRef = ref(db, `users/${uid}`);
        // initial get + create-if-missing
        get(userRef).then(snapshot => {
          if(snapshot.exists()){
            renderUserData(snapshot.val());
          } else {
            // create minimal record
            const initial = { email: (auth.currentUser && auth.currentUser.email) || localStorage.getItem('cipherq_email') || '', createdAt: Date.now(), apis: {} };
            set(userRef, initial).then(()=> renderUserData(initial)).catch(e=>console.error('set user record failed', e));
          }
        }).catch(e=>console.error('get user failed', e));

        // realtime updates
        onValue(userRef, snap => {
          if(snap.exists()) renderUserData(snap.val());
        });
      }catch(e){
        console.warn('Failed to fetch/listen user', e);
      }
    }

    // Use Firebase Auth state instead of localStorage for authoritative identity
    onAuthStateChanged(auth, user => {
      const userInfo = document.getElementById('userInfo');
      if(user){
        // show email and uid
        userInfo.textContent = `${user.email || ''} · ${user.uid}`;
        // ensure localStorage still set for older flows
        try{ localStorage.setItem('cipherq_uid', user.uid); if(user.email) localStorage.setItem('cipherq_email', user.email); }catch(e){}
        // start DB listener
        fetchAndListenUser(user.uid);
      } else {
        userInfo.innerHTML = `<a href="auth.html" style="color:#7dd3fc;text-decoration:none">Sign in</a>`;
        // clear UI
        content.innerHTML = `<h3>Welcome</h3><p>Please sign in to see your API keys and manage them.</p>`;
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try{
        await signOut(auth);
      }catch(e){console.warn('signOut failed',e)}
      try{ localStorage.removeItem('cipherq_uid'); localStorage.removeItem('cipherq_email'); }catch(e){}
      window.location.href = 'auth.html';
    });
  </script>

</body>
</html>

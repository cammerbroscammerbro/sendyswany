<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CipherQ Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0a0a0a;
      color: #fff;
      font-family: "Poppins", sans-serif;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      border-right: 1px solid #222;
    }

    .sidebar h2 {
      margin-bottom: 40px;
      font-size: 22px;
      letter-spacing: 1px;
    }

    .sidebar button {
      width: 80%;
      margin: 10px 0;
      padding: 12px 0;
      background: #1b1b1b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .sidebar button.active {
      background: #007bff;
    }

    .sidebar button:hover {
      background: #333;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 25px;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 25px;
    }

    .get-key-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .get-key-btn:hover {
      background: #0056b3;
    }

    /* Content area */
    .content-area {
      flex: 1;
      background: #121212;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
    }

    .content-area h3 {
      font-size: 20px;
      margin-bottom: 15px;
    }

    .api-key-box {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>CipherQ</h2>
    <button id="apiKeyBtn" class="active">API Key</button>
    <button id="docsBtn">Docs</button>
  </div>

  <!-- Main Section -->
  <div class="main-content">
    <div class="top-bar">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="get-key-btn">Get API Key</button>
        <div id="userInfo" style="color:#cbd5e1;font-size:14px;">
          <!-- UID/email will be injected here -->
        </div>
        <button id="logoutBtn" style="margin-left:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe8ff;padding:8px 12px;border-radius:8px;cursor:pointer">Logout</button>
      </div>
    </div>

    <div id="contentArea" class="content-area">
      <h3>Your API Key</h3>
      <p>Welcome to CipherQ Quantum Encryption API. Here’s your generated API Key:</p>
      <div class="api-key-box" id="apiKeyBox">
        21ae5bd31aadb0bd76a5390139fd1267e414da5ee39250a5d294c2c0e65ecba4
      </div>
      <p style="margin-top: 15px;">Use this key with your HTTP headers as:  
        <code style="background:#222;padding:5px 10px;border-radius:5px;">X-API-KEY: your_api_key_here</code>
      </p>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const apiBtn = document.getElementById('apiKeyBtn');
    const docsBtn = document.getElementById('docsBtn');
    const content = document.getElementById('contentArea');

    // Public (read-only) view if ?public_uid=<UID> is provided in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const publicUid = urlParams.get('public_uid') || urlParams.get('share_uid');
    let isPublicView = false;
    if(publicUid){
      isPublicView = true;
      // hide controls that require auth
      const logoutBtn = document.getElementById('logoutBtn'); if(logoutBtn) logoutBtn.style.display = 'none';
      const topGetBtn = document.querySelector('.get-key-btn'); if(topGetBtn) topGetBtn.style.display = 'none';
    }

    // --- Create Key Modal markup (injected) ---
    (function insertCreateKeyModal(){
      const modalHtml = `
        <div id="createKeyModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999">
          <div style="background:#0b0b0b;padding:20px;border-radius:12px;border:1px solid #222;min-width:320px;color:#e6eef8">
            <h3 style="margin-top:0">Generate API Key</h3>
            <div style="margin:8px 0"><label style="font-size:13px;color:#9aa6b8">Name</label>
              <input id="newKeyName" style="width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #222;background:#061017;color:#fff" placeholder="e.g. My App Server"></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="cancelCreateKey" style="background:transparent;border:1px solid #333;padding:8px 12px;border-radius:8px;color:#cfe8ff">Cancel</button>
              <button id="confirmCreateKey" style="background:#06b6d4;border:none;padding:8px 12px;border-radius:8px;color:#04283a">Generate</button>
            </div>
            <div id="createKeyMsg" style="margin-top:8px;color:#9aa6b8;font-size:13px"></div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      document.getElementById('cancelCreateKey').addEventListener('click', ()=>{ document.getElementById('createKeyModal').style.display='none'; });
      document.getElementById('confirmCreateKey').addEventListener('click', async ()=>{
        const name = (document.getElementById('newKeyName').value || '').trim();
        if(!name){ document.getElementById('createKeyMsg').textContent = 'Please provide a name.'; return; }
        document.getElementById('createKeyMsg').textContent = 'Generating...';
        try{
          await createApiKeyForCurrentUser(name);
          document.getElementById('createKeyMsg').textContent = 'API key created.';
          setTimeout(()=>{ document.getElementById('createKeyModal').style.display='none'; document.getElementById('newKeyName').value=''; }, 700);
        }catch(err){
          console.error('create key failed', err);
          document.getElementById('createKeyMsg').textContent = 'Failed to create key';
        }
      });
    })();

    function showCreateKeyModal(){
      const modal = document.getElementById('createKeyModal');
      if(modal) modal.style.display = 'flex';
    }

    apiBtn.addEventListener('click', () => {
      apiBtn.classList.add('active');
      docsBtn.classList.remove('active');
      // content controlled by auth listener
    });

    docsBtn.addEventListener('click', () => {
      // open docs in same tab (full page)
      window.location.href = "doc.html";
    });

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqzy8ivw9QZG6RXNQmoTKAWY_1uunTTrw",
      authDomain: "pcq-api.firebaseapp.com",
      databaseURL: "https://pcq-api-default-rtdb.firebaseio.com",
      projectId: "pcq-api",
      storageBucket: "pcq-api.firebasestorage.app",
      messagingSenderId: "759573347127",
      appId: "1:759573347127:web:2e89d43e000b4df57838b2",
      measurementId: "G-RTT59R8JBW"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

    // Utility: escape HTML for safe rendering
    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]);
    }

    // Render user data (APIs and meta) with delete/revoke controls from Realtime Database records
    function renderUserDataFromDocs(docs){
      let html = `<h3>Your API Keys</h3>`;
      if(docs.length){
        html += '<div id="userApis">';
        docs.forEach(d => {
            const k = d.id;
            const v = d.data;
            // when keys are stored with the key as the node, fall back to the id
            const keyText = v && v.key ? v.key : k;
            const name = v && v.name ? v.name : (v && v.display_name ? v.display_name : ('Key ' + escapeHtml(k.slice(0,6))));
          const created = v && v.created_at ? escapeHtml(v.created_at) : '';
          const status = v && v.status ? v.status : 'unknown';
          const usage = (v && typeof v.usage_count !== 'undefined') ? v.usage_count : '';
          // Show name as the main line; clicking the name toggles details (token + copy)
          html += `<div class="api-key-box" data-id="${escapeHtml(k)}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                      <div>
                        <div class="keyName" data-id="${escapeHtml(k)}" style="cursor:pointer;font-weight:700">${escapeHtml(name)}</div>
                        <div style="color:#9aa6b8;font-size:12px;margin-top:6px">id: ${escapeHtml(k)} · ${created} · ${escapeHtml(status)} · usage: ${escapeHtml(String(usage))}</div>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:8px">
                        <button class="copyBtn" data-key="${escapeHtml(keyText)}" style="background:#0ea5e9;border-radius:8px;padding:8px;border:none;color:white;cursor:pointer">Copy</button>
                      </div>
                    </div>
                    <div class="keyDetails" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.03)">
                      <div style="font-family:monospace;word-break:break-all">${escapeHtml(keyText)}</div>
                    </div>
                  </div>`;
        });
        html += '</div>';
      } else {
        html += `<p>No API keys yet for this account.</p>`;
        html += `<button id="createKeyBtn" class="get-key-btn">Create API Key</button>`;
      }

      content.innerHTML = html;

      const createBtn = document.getElementById('createKeyBtn');
      if(createBtn) createBtn.addEventListener('click', showCreateKeyModal);

      // attach copy and name-toggle handlers
      document.querySelectorAll('.copyBtn').forEach(b=> b.addEventListener('click', async (e)=>{
        const key = e.currentTarget.getAttribute('data-key') || '';
        try{
          await navigator.clipboard.writeText(key);
          alert('API key copied to clipboard');
        }catch(_){
          const ta = document.createElement('textarea'); ta.value = key; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
          alert('API key copied to clipboard');
        }
      }));

      document.querySelectorAll('.keyName').forEach(n => n.addEventListener('click', (e) =>{
        const container = e.currentTarget.closest('.api-key-box');
        if(!container) return;
        const details = container.querySelector('.keyDetails');
        if(!details) return;
        details.style.display = (details.style.display === 'none' || details.style.display === '') ? 'block' : 'none';
      }));
    }

    // Generate a secure-ish API key (client-side). For production, generate on server.
    function generateApiKey(){
      const arr = new Uint8Array(24);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function createApiKeyForCurrentUser(name){
      const user = auth.currentUser;
      if(!user){ alert('No user signed in.'); return; }
      const uid = user.uid;
      console.debug('createApiKeyForCurrentUser - auth.currentUser:', user);

      const newKey = generateApiKey();
      try{
        // Save the API key as the child node itself (so server can look up by token)
        await set(ref(db, `api_keys/${newKey}`), {
          owner: uid,
          name: name || '',
          created_at: new Date().toISOString(),
          created_at_ts: Date.now(),
          status: 'active',
          usage_count: 0
        });
        // success
        return;
      }catch(err){
        console.error('createApiKeyForCurrentUser - db error', err);
        alert('Could not create API key. See console for details.');
      }
    }

    // wire the top-bar Get API Key button to create a key for convenience
    (function wireTopGetKey(){
      const topBtn = document.querySelector('.get-key-btn');
      if(!topBtn) return;
      if(isPublicView){ topBtn.style.display = 'none'; return; }
      topBtn.addEventListener('click', (e) => {
        showCreateKeyModal();
      });
    })();

    // Realtime Database listener - either public view (by publicUid) or auth-based
    let unsubscribe = null;
    function attachListenerForOwner(ownerUid){
      if(unsubscribe) { try{ unsubscribe(); }catch(e){}; unsubscribe = null; }
      unsubscribe = onValue(ref(db, 'api_keys'), snapshot => {
        const docs = [];
        snapshot.forEach(child => {
          const val = child.val();
          if(val && val.owner === ownerUid){
            docs.push({ id: child.key, data: val });
          }
        });
        docs.sort((a,b)=>{
          const ta = (a.data && typeof a.data.created_at_ts === 'number') ? a.data.created_at_ts : (a.data && a.data.created_at ? Date.parse(a.data.created_at) : 0);
          const tb = (b.data && typeof b.data.created_at_ts === 'number') ? b.data.created_at_ts : (b.data && b.data.created_at ? Date.parse(b.data.created_at) : 0);
          return tb - ta;
        });
        renderUserDataFromDocs(docs);
      }, err => {
        console.error('onValue error', err);
      });
    }

    if(isPublicView){
      // Directly attach a listener for the requested publicUid
      attachListenerForOwner(publicUid);
      const userInfo = document.getElementById('userInfo');
      userInfo.textContent = `Public view · ${publicUid}`;
    } else {
      // Use Auth state to attach listener for signed-in user
      onAuthStateChanged(auth, user => {
        const userInfo = document.getElementById('userInfo');
        console.debug('onAuthStateChanged - user:', user);
        if(user){
          userInfo.textContent = `${user.email || ''} · ${user.uid}`;
          try{ localStorage.setItem('cipherq_uid', user.uid); if(user.email) localStorage.setItem('cipherq_email', user.email); }catch(e){}

          // log id token for debugging
          user.getIdToken(false).then(token => {
            console.debug('onAuthStateChanged - idToken (first 80 chars):', token ? token.slice(0,80) + '...' : token);
          }).catch(err => console.warn('onAuthStateChanged - getIdToken failed', err));

          attachListenerForOwner(user.uid);
        } else {
          userInfo.innerHTML = `<a href="auth.html" style="color:#7dd3fc;text-decoration:none">Sign in</a>`;
          if(unsubscribe) { unsubscribe(); unsubscribe = null; }
          content.innerHTML = `<h3>Welcome</h3><p>Please sign in to see your API keys and manage them.</p>`;
        }
      });
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try{
        await signOut(auth);
      }catch(e){console.warn('signOut failed',e)}
      try{ localStorage.removeItem('cipherq_uid'); localStorage.removeItem('cipherq_email'); }catch(e){}
      window.location.href = 'auth.html';
    });
  </script>

</body>
</html>


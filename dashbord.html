<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CipherQ Dashboard</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0a0a0a;
      color: #fff;
      font-family: "Poppins", sans-serif;
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
      border-right: 1px solid #222;
    }

    .sidebar h2 {
      margin-bottom: 40px;
      font-size: 22px;
      letter-spacing: 1px;
    }

    .sidebar button {
      width: 80%;
      margin: 10px 0;
      padding: 12px 0;
      background: #1b1b1b;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .sidebar button.active {
      background: #007bff;
    }

    .sidebar button:hover {
      background: #333;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 25px;
    }

    /* Top bar */
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 25px;
    }

    .get-key-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .get-key-btn:hover {
      background: #0056b3;
    }

    /* Content area */
    .content-area {
      flex: 1;
      background: #121212;
      border-radius: 10px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
    }

    .content-area h3 {
      font-size: 20px;
      margin-bottom: 15px;
    }

    .api-key-box {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 14px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>CipherQ</h2>
    <button id="apiKeyBtn" class="active">API Key</button>
    <button id="docsBtn">Docs</button>
  </div>

  <!-- Main Section -->
  <div class="main-content">
    <div class="top-bar">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="get-key-btn">Get API Key</button>
        <div id="userInfo" style="color:#cbd5e1;font-size:14px;">
          <!-- UID/email will be injected here -->
        </div>
        <button id="logoutBtn" style="margin-left:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe8ff;padding:8px 12px;border-radius:8px;cursor:pointer">Logout</button>
      </div>
    </div>

    <div id="contentArea" class="content-area">
      <h3>Your API Key</h3>
      <p>Welcome to CipherQ Quantum Encryption API. Here’s your generated API Key:</p>
      <div class="api-key-box" id="apiKeyBox">
        21ae5bd31aadb0bd76a5390139fd1267e414da5ee39250a5d294c2c0e65ecba4
      </div>
      <p style="margin-top: 15px;">Use this key with your HTTP headers as:  
        <code style="background:#222;padding:5px 10px;border-radius:5px;">X-API-KEY: your_api_key_here</code>
      </p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const apiBtn = document.getElementById('apiKeyBtn');
    const docsBtn = document.getElementById('docsBtn');
    const content = document.getElementById('contentArea');

    apiBtn.addEventListener('click', () => {
      apiBtn.classList.add('active');
      docsBtn.classList.remove('active');
      // content controlled by auth listener
    });

    docsBtn.addEventListener('click', () => {
      // open docs in same tab (full page)
      window.location.href = "doc.html";
    });

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqzy8ivw9QZG6RXNQmoTKAWY_1uunTTrw",
      authDomain: "pcq-api.firebaseapp.com",
      projectId: "pcq-api",
      storageBucket: "pcq-api.firebasestorage.app",
      messagingSenderId: "759573347127",
      appId: "1:759573347127:web:2e89d43e000b4df57838b2",
      measurementId: "G-RTT59R8JBW"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Utility: escape HTML for safe rendering
    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]);
    }

    // Render user data (APIs and meta) with delete/revoke controls from Firestore docs
    function renderUserDataFromDocs(docs){
      let html = `<h3>Your API Keys</h3>`;
      if(docs.length){
        html += '<div id="userApis">';
        docs.forEach(d => {
          const k = d.id;
          const v = d.data();
          const keyText = v && v.key ? v.key : '';
          const created = v && v.created_at ? escapeHtml(v.created_at) : '';
          const status = v && v.status ? v.status : 'unknown';
          const usage = (v && typeof v.usage_count !== 'undefined') ? v.usage_count : '';
          html += `<div class="api-key-box" data-id="${escapeHtml(k)}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                      <div><strong style="font-family:monospace">${escapeHtml(keyText)}</strong>
                        <div style="color:#9aa6b8;font-size:12px;margin-top:6px">id: ${escapeHtml(k)}</div>
                        <div style="color:#9aa6b8;font-size:12px">${created} · ${escapeHtml(status)} · usage: ${escapeHtml(String(usage))}</div>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:8px">
                        <button class="revokeBtn" data-id="${escapeHtml(k)}" style="background:#f97316;border-radius:8px;padding:8px;border:none;color:white;cursor:pointer">Revoke</button>
                        <button class="deleteBtn" data-id="${escapeHtml(k)}" style="background:#ef4444;border-radius:8px;padding:8px;border:none;color:white;cursor:pointer">Delete</button>
                      </div>
                    </div>
                  </div>`;
        });
        html += '</div>';
      } else {
        html += `<p>No API keys yet for this account.</p>`;
        html += `<button id="createKeyBtn" class="get-key-btn">Create API Key</button>`;
      }

      content.innerHTML = html;

      const createBtn = document.getElementById('createKeyBtn');
      if(createBtn) createBtn.addEventListener('click', createApiKeyForCurrentUser);

      // attach delete/revoke
      document.querySelectorAll('.deleteBtn').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if(!confirm('Delete this API key permanently?')) return;
        try{
          await deleteDoc(doc(db, 'api_keys', id));
        }catch(err){console.error(err);alert('Failed to delete key')}
      }));

      document.querySelectorAll('.revokeBtn').forEach(b=> b.addEventListener('click', async (e)=>{
        const id = e.currentTarget.getAttribute('data-id');
        if(!confirm('Revoke this API key?')) return;
        try{
          await updateDoc(doc(db, 'api_keys', id), { status: 'revoked' });
        }catch(err){console.error(err);alert('Failed to revoke key')}
      }));
    }

    // Generate a secure-ish API key (client-side). For production, generate on server.
    function generateApiKey(){
      const arr = new Uint8Array(24);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function createApiKeyForCurrentUser(){
      const user = auth.currentUser;
      if(!user){ alert('No user signed in.'); return; }
      const uid = user.uid;
      const newKey = generateApiKey();
      const payload = {
        key: newKey,
        owner: uid,
        created_at: new Date().toISOString(),
        created_at_ts: serverTimestamp(),
        status: 'active',
        usage_count: 0
      };

      // helper to log details
      function logErrorDetails(err){
        try{
          console.error('Failed to create API key', err);
          if(err && typeof err === 'object'){
            // FirebaseError contains code and message
            console.error('error.code =>', err.code);
            console.error('error.message =>', err.message);
          }
        }catch(_){console.error('Error while logging error details', _)}
      }

      try{
        await addDoc(collection(db, 'api_keys'), payload);
        return;
      }catch(e){
        logErrorDetails(e);
        // retry once after brief delay
        try{
          await new Promise(r=>setTimeout(r,250));
          await addDoc(collection(db, 'api_keys'), payload);
          return;
        }catch(e2){
          logErrorDetails(e2);
          alert('Could not create API key. See console for details (network, error.code, error.message).');
        }
      }
    }

    // wire the top-bar Get API Key button to create a key for convenience
    (function wireTopGetKey(){
      const topBtn = document.querySelector('.get-key-btn');
      if(!topBtn) return;
      topBtn.addEventListener('click', async (e) => {
        // disable briefly to prevent double clicks
        topBtn.disabled = true;
        try {
          await createApiKeyForCurrentUser();
        } finally {
          setTimeout(()=> topBtn.disabled = false, 800);
        }
      });
    })();

    // Use Firebase Auth state and Firestore real-time listener
    let unsubscribe = null;
    onAuthStateChanged(auth, user => {
      const userInfo = document.getElementById('userInfo');
      if(user){
        userInfo.textContent = `${user.email || ''} · ${user.uid}`;
        try{ localStorage.setItem('cipherq_uid', user.uid); if(user.email) localStorage.setItem('cipherq_email', user.email); }catch(e){}

        // attach Firestore listener to api_keys where owner == uid
        const q = query(collection(db, 'api_keys'), where('owner', '==', user.uid), orderBy('created_at_ts', 'desc'));
        if(unsubscribe) unsubscribe();
        unsubscribe = onSnapshot(q, snapshot => {
          const docs = [];
          snapshot.forEach(d => docs.push(d));
          renderUserDataFromDocs(docs);
        }, err => {
          console.error('snapshot error', err);
        });
      } else {
        userInfo.innerHTML = `<a href="auth.html" style="color:#7dd3fc;text-decoration:none">Sign in</a>`;
        if(unsubscribe) { unsubscribe(); unsubscribe = null; }
        content.innerHTML = `<h3>Welcome</h3><p>Please sign in to see your API keys and manage them.</p>`;
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try{
        await signOut(auth);
      }catch(e){console.warn('signOut failed',e)}
      try{ localStorage.removeItem('cipherq_uid'); localStorage.removeItem('cipherq_email'); }catch(e){}
      window.location.href = 'auth.html';
    });
  </script>

</body>
</html>

